%!
%% cridat per componedoraRIMDA00.php

%% URLs amb errors NOUS?

%% URLs bones per implicar almenys 1 element de cadascuna de les 4 taules de blancs:
%% es compon en un A4 vertical
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=72&mesura=151p&reng=/espai(36 72 g)/interlinia(1p6C g)/llengot(18P6Cg)/imposicio (8c)
%% es compon en un A3 horitzontal
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=6c&mesura=775P&reng=/espai(48p72PG)/interlinia(1 6cG)/llengot(6p 6Cg)/imposicio(60c)
%% només 3 peces primes i curtes
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=8P&reng=/interlinia(1 6cG)/llengot(6p 6Cg)/interlinia(1 6cG)
%% exemple bo encara que s'ometi la / a les peces del reng
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=21P&reng= interlinia(1%206cG) llengot(6p%206Cg) interlinia(1%206cG) llengot(6p%206Cg) interlinia(1%206cG) llengot(6p%206Cg)

%% apunts de l'Enric Tormo:
%% 1 Pica aglesa (no la PS ianqui), o sigui un cícero amglès, equival exactament a 11 punts Didot
%% 48 punts Didot = 18 mm = concordança mestre
%% 4 mòduls del 12 punt són 48 punts
%% 48 mòduls tipogràfics a cos 8 tens concordança (a ?) cada 8 quadratins
%% si apliques aquest mòdul els mm deixen de tenir base 10 per tenir base 6


%(\n\nB O N   D I A  !\n\n) print flush
%(B [O] N =  D I A  !\n\n) print flush

(laURL) getenv
{
 /laURL exch def
}
{
 pstack HIHAhagutUNerrorENlaCAPTURAdelaURL
}ifelse

%% capturem les variables d'entorn provinents de componedoraRIMDA00.php 

(MRCT_nu) getenv  %% la variable d'entorn existeix?  de si només perfilem les peces o mostrem ple (color o imatge) el seu interior
{  %% existeix perquè l'hem inicialitzat via php i hauria de dur una string amb valors
  dup length 0 eq
 {  %% arriba buida perquè l'executem amb el php sense paràmetres, o no l'hem escrit, o no l'hem escrit bé, o no hem escrit el =, o no hem escrit el = enganxat a cos=
    %% no cal gestionar cap error perquè no afecta a la sintaxi
  pop 
  /nua false def
%cosNOEXISTEIXoesBUIDA!
 }
 {  %% té dades perquè l'executem via php mètode $_POST o via URL php amb paràmetres mètode $_GET
  cvx exec  %% és una string que hauríem d'avaluar si el que duu és correcte per un segon nivell d'error de sintaxi?
  /nua exch def
%cosAVEUREQUEDUUS?
 }ifelse
}
{  %% NO existeix perquè estem executant l'applet en local via Terminal per línia de comanda
%cosVIAterminal!
  /nua true def
}ifelse

(MRCT_cos) getenv  %% la variable d'entorn existeix?
{  %% existeix perquè l'hem inicialitzat via php i hauria de dur una string amb valors
  dup length 0 eq
 {  %% arriba buida perquè l'executem amb el php sense paràmetres, o no l'hem escrit, o no l'hem escrit bé, o no hem escrit el =, o no hem escrit el = enganxat a cos=
    %% ara cal gestionar aquest primer nivell d'error de sintaxi
  pop /HIHAcos false def
%cosNOEXISTEIXoesBUIDA!
 }
 {  %% té dades perquè l'executem via php mètode $_POST o via URL php amb paràmetres mètode $_GET
  %cvx exec  %% és una string que hem d'avaluar si el que duu és correcte per un segon nivell d'error de sintaxi
  /cosVAL exch def
  /HIHAcos true def
%cosAVEUREQUEDUUS?
 }ifelse
}
{  %% NO existeix perquè estem executant l'applet en local via Terminal per línia de comanda
%cosVIAterminal!
 8 /cosVAL exch def
 /HIHAcos true def
}ifelse

(MRCT_mesura) getenv  %% la variable d'entorn existeix?
{  %% existeix perquè l'hem inicialitzat via php i hauria de dur una string amb valors
 dup length 0 eq
 {  %% arriba buida perquè l'executem amb el php sense paràmetres, o no l'hem escrit, o no l'hem escrit bé, o no hem escrit el =, o no hem escrit el = enganxat a mesura=
    %% ara cal gestionar aquest primer nivell d'error de sintaxi
  pop /HIHAmesura false def
%mesuraNOEXISTEIXoesBUIDA!
 }
 {  %% té dades perquè l'executem via php mètode $_POST o via URL php amb paràmetres mètode $_GET
  %cvx exec  %% és una string que hem d'avaluar si el que duu és correcte per un segon nivell d'error de sintaxi
  /mesuraVAL exch def
  /HIHAmesura true def
%mesuraAVEUREQUEDUUS?
 }ifelse
}
{  %% NO existeix perquè estem executant l'applet en local via Terminal per línia de comanda
%mesuraVIAterminal!
 100 /mesuraVAL exch def
 /HIHAmesura true def
}ifelse

(MRCT_reng) getenv  %% la variable d'entorn existeix?
{  %% existeix perquè l'hem inicialitzat via php i hauria de dur una string amb valors
 dup length 0 eq
 {  %% arriba buida perquè l'executem amb el php sense paràmetres, o no l'hem escrit, o no l'hem escrit bé, o no hem escrit el =, o no hem escrit el = enganxat a reng=
    %% ara cal gestionar aquest primer nivell d'error de sintaxi
  pop /HIHAreng false def
%rengNOEXISTEIXoesBUIDA!
 }
 {  %% té dades perquè l'executem via php mètode $_POST o amb URL php amb paràmetres mètode $_GET
  %cvx exec  %% és una string que hem d'avaluar si el que duu és correcte per un segon nivell d'error de sintaxi
  /rengVAL exch def
  /HIHAreng true def
%rengAVEUREQUEDUUS?
 }ifelse
}
{  %% NO existeix perquè estem executant l'applet en local via Terminal per línia de comanda
%rengVIAterminal!
 (/llengot (6c)/espai(1/4)/espai(1/4)/espai(1/3) /espai(1/2) /espai(12 1/2 g) /llengot(5C) /espai(18))
 /rengVAL exch def
 /HIHAreng true def

}ifelse

%% buffer de missatges per la finestra del prompt JS
/tOU 2048 string def  %% una cadena amb capacitat de sobres
tOU /NullEncode filter /fotli exch def  %% l'string com a fitxer d'escriptura

/hihaERROR false def  %% gatell per saber si hem de generar o no el PDF gràfic amb el reng

%% filtrem els errors de sintaxi dels noms i existència de les 3 variables
HIHAcos HIHAmesura HIHAreng and and
{  %% hi són totes 3
 /URLnorm
 [  %% array normalitzada en ordre i valors originals de la URL que s'ha escrit al navegador per executar la composició d'1 línia de blancs
  []  %% cos en punts Didot o cíceros Didot de totes les peces dins la línia a compondre
  []  %% mesura de la línia a compondre en punts Didot o cíceros Didot
  []  %% reng a compondre, amb cadascun dels tipus de peça i valors Didot
 ]def

 /LINPSnorm
 [  %% array normalitzada en ordre i valors en punts de Pica Postscript per composar a PDF 1 línia de blancs
  []  %% cos en punts de Pica PS
  []  %% mesura de la línia a compondre en punts de Pica PS
  []  %% reng a compondre, amb cadascun dels rectangles de Mesures de Blancs en punts de Pica PS i girades si s'escau
 ]def

 %% els diccionaris s'han de definir dins de {} perquè s'executin correctament en el seu context!
 /CONTEXTnorm
 {
  <<  %% definicions de /p i /c per fixar els valors per treballar el PDF
    /p
    {  %% conversor de punts Didot a punts de Pica PS
     1.06554329 mul
    }bind def

    /c
    {  %% conversor de cíceros Didot a punts de Picas PS
     12 mul 1.06554329 mul
    }bind def
  >>
 }bind def

 /CONTEXTerrors
 {
  <<  %% definicions de /p /c /g per facilitar el filtrat d'errors
    /p
    {  %% per tal que tot treballi en punts Didot
     cvi  %% ens cal assegurar que ara sempre treballarem amb enters
    }bind def

    /c
    {  %% per tal que tot treballi en punts Didot
     12 mul cvi  %% ens cal assegurar que ara sempre treballarem amb enters
    }bind def

    /g
    {  %% fa que el cos sigui l'ample i viceversa
     exch
     userdict /girem true put  %% desem el gatell fora del diccionari per saber que hem capgirat els valors a l'stack: el cos passarà al lloc de l'ample i viceversa
    }bind def
  >>
 }bind def

 /CONTEXTindex
 {
  <<  %% definicions de /p /c per convertir les unitats del cos o ample a les mateixes que actuen a les taules
    /p
    {  %% conversor de punts Didot a cíceros Didot
     12 div cvi  %% ens cal assegurar que ara sempre treballarem amb enters
    }bind def

    /c
    {  %% conversor de cíceros Didot a punts Didot
     12 mul cvi %% ens cal assegurar que ara sempre treballarem amb enters
    }bind def
  >>
 }bind def

 /CONTEXTindexAMPLE
 {
  <<  %% definicions de /p /c /g per treballar les unitats d'ample que actuen a les taules
  %% desant en paral·lel a /uPample el literal de les unitats d'ample i a /vPample el valor d'ample en aquestes mateixes unitats
    /p
    {  %% ídem
     /p
    }bind def

    /c
    {  %% ídem
     /c
    }bind def

    /g
    {  %% capgira els elements fent que el cos sigui l'ample i viceversa, amb unitats o sense
     %% hi ha 6 comportaments diferenciats per si hi ha 1, 2, 3 o 4 elements dins l'array, amb unitats o sense:
     counttomark 3 eq
     {
      dup type /nametype eq
      {
       3 1 roll 3 1 roll
      }
      {
       3 1 roll
      }ifelse
     }
     {
      counttomark 4 eq
      {
       4 1 roll 4 1 roll
      }
      {  %% és de 2 o 1
       counttomark 2 eq
       {
        dup type /nametype ne
        {
         exch
        }if
       }if
      }ifelse
     }ifelse
     userdict /girem true put  %% desem el gatell fora del diccionari per saber que hem aplicat g
    }bind def
  >>
 }bind def


 %% filtrem els errors de sintaxi del valor de cos
 HIHAcos
 {  %% si hi ha cos
  mark

  cosVAL  %% l'string amb els valors que, un cop analitzats, es convertiran en l'array hies
  (llegeixValorsDvariables.ps) (r) file cvx exec  %% isembla que és més eficient executar-ho com a fitxer extern

  cleartomark

  %% malgrat que l'anterior algorisme planxa i fa net de caràcters estranys, filtrem encara errors possibles:
  %% que hi hagi 3 o més elements?
  hies length dup 0 eq
  {
   pop
%%S'ESDEVÉ si per exemple només hi han espais en blanc o altres caràcters estranys a la sintaxi
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=%20%20%20&mesura=%20%20%20&reng=/interlinia(%20%20%20)
%% (1) (5) Error: /stackunderflow in --copy-- Operand stack: 0 2
   fotli (\\n\\n[#01] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &cos=\\n\\n)writestring
   fotli (>> no hi ha cap valor vàlid)writestring
   /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(1)==  %% marquem on activem els gatells d'error per pentinar
  }
  {
   3 ge
   {
%%S'ESDEVÉ si repetim més d'1 caràcter d'unitats… c p …o gir… g
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=12pp%20&mesura=300%20&reng=/interlinia(%20%20%20)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96p&mesura=6cp&reng=/imposicio(6c96pG)
    fotli (\\n\\n[#02] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &cos=\\n\\n)writestring
    fotli (>> hi heu introduït massa valors)writestring
    /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(2)==  %% marquem on activem els gatells d'error per pentinar
   }
   {
    %% que el primer element no sigui un enter o un real?
    hies 0 get type dup /integertype eq exch /realtype eq or
    {
     hies length 2 eq
     {  %% en cas que hi hagi un segon element
      %% que el segon element sigui una /g (no sigui una /p o una /c) o un altre enter?
      hies 1 get dup /c eq exch /p eq or
      {  %% tot correcte i potser treballi en cíceros!
       %% fem un doble desat:
       %% desant la successió dels valors normalitzats de la URL per metadades i per consultar l'existència de la peça a les taules
       URLnorm 0 hies put  %% a l'índex zero hi va el valor del cos
       %% convertint els valors a unitats de punts PS, a punt per ser cridats per generar el PDF
       LINPSnorm 0 [ CONTEXTnorm begin hies {cvx exec}forall end ] put
      }
      {  %% és una /g o un altre enter!
%%S'ESDEVÉ si escrivim un caràcter g en comptes d'una unitat c p
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?mesura=13g8p&cos=6g&reng=/llengot%20(6c)/espai(1/4)/espai(1/4)/espai(1/3)%20/espai(1/2)%20/espai(12%201/2%20g)%20/llengot(5g)%20/espai(18)
%% (3) (6) Error: /stackunderflow in --copy-- Operand stack: 0 2
       fotli (\\n\\n[#http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=12pp%20&mesura=300%20&reng=/interlinia(%20%20%20)03] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &cos=\\n\\n)writestring
       fotli (>> el segon valor no és cap unitat)writestring
       /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(3)==  %% marquem on activem els gatells d'error per pentinar
      }ifelse
     }
     {  %% tot correcte i treballa en punts!
      %% fem un doble desat:
      %% desant la successió dels valors normalitzats de la URL per metadades i per consultar l'existència de la peça a les taules
      URLnorm 0 [ hies cvx exec /p ]  %% com que no la duu hi afegim les unitats
      put  %% a l'índex zero hi va el valor del cos
      %% convertint els valors a unitats de punts PS, a punt per ser cridats per generar el PDF
      LINPSnorm 0 [ CONTEXTnorm begin hies cvx exec p end ] put
     }ifelse
    }
    {  %% no és cap numèric
%%S'ESDEVÉ si escrivim les unitats sense cap valor numèric
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=p%20&mesura=c%20&reng=/interlinia(p)
%% (4) (8) Error: /stackunderflow in --copy-- Operand stack: 0 2
     fotli (\\n\\n[#04] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &cos=\\n\\n)writestring
     fotli (>> el primer valor no és cap numèric)writestring
     /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(4)==  %% marquem on activem els gatells d'error per pentinar
    }ifelse
   }ifelse
  }ifelse
 }if

 %% filtrem els errors de sintaxi del valor de mesura
 HIHAmesura
 {  %% si hi ha mesura
  mark

  mesuraVAL  %% l'string amb els valors que, un cop analitzats, es convertiran en l'array hies

  (llegeixValorsDvariables.ps) (r) file cvx exec  %% sembla que és més eficient executar-ho com a fitxer extern

  cleartomark

  %% malgrat que l'anterior algorisme planxa i fa net de caràcters estranys, filtrem encara errors possibles:
  %% que hi hagi 3 o més elements?
  hies length dup 0 eq
  {
   pop
%%S'ESDEVÉ si per exemple només hi han espais en blanc o altres caràcters estranys a la sintaxi
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=%20%20%20&mesura=%20%20%20&reng=/interlinia(%20%20%20)
%% (1) (5) Error: /stackunderflow in --copy-- Operand stack: 0 2
   fotli (\\n\\n[#05] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &mesura=\\n\\n)writestring
   fotli (>> no hi ha cap valor vàlid)writestring
   /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(5)==  %% marquem on activem els gatells d'error per pentinar
  }
  {
   3 ge
   {
%%S'ESDEVÉ si s'han introduï 3 o més enters, complint-se el què diu el missatge, vegeu l'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96p&mesura=6cp&reng=/imposicio(6c96pG)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?mesura=13c8p&cos=6&reng=/llengot (6c)/espai(1/4)/espai(1/4)/espai(1/3) /espai(1/2) /espai(12 1/2 g) /llengot(5c) /espai(18)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=72&mesura=300 1 1 &reng=/interlinia(3 72 g)
%% (6) Error: /stackunderflow in --copy-- Operand stack: 0 2
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?mesura=13g8p&cos=6g&reng=/llengot%20(6c)/espai(1/4)/espai(1/4)/espai(1/3)%20/espai(1/2)%20/espai(12%201/2%20g)%20/llengot(5g)%20/espai(18)
%% (3) (6) Error: /stackunderflow in --copy-- Operand stack: 0 2
    fotli (\\n\\n[#06] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &mesura=\\n\\n)writestring
    fotli (>> hi heu introduït massa valors)writestring
    /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(6)==  %% marquem on activem els gatells d'error per pentinar
   }
   {
    %% que el primer element no sigui un enter o un real?
    hies 0 get type dup /integertype eq exch /realtype eq or
    {
     hies length 2 eq
     {  %% en cas que hi hagi un segon element
      %% que el segon element sigui una /g (no sigui una /p o una /c) o un altre enter?
      hies 1 get dup /c eq exch /p eq or
      {  %% tot correcte i potser treballi en cíceros!
       %% fem un doble desat:
       %% desant la successió dels valors normalitzats de la URL per metadades i per consultar l'existència de la peça a les taules
       URLnorm 1 hies put  %% a l'índex u hi va el valor de la mesura
       %% convertint els valors a unitats de punts PS, a punt per ser cridats per generar el PDF
       LINPSnorm 1 [ CONTEXTnorm begin hies {cvx exec}forall end ] put
      }
      {  %% és una /g o un altre enter!
%%S'ESDEVÉ si es compleix el què diu el comentari, el missatge o l'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=72&mesura=300 1 &reng=/interlinia(3 72 g)
%% (7) Error: /stackunderflow in --copy-- Operand stack: 0 2
       fotli (\\n\\n[#07] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &mesura=\\n\\n)writestring
       fotli (>> el segon valor no és cap unitat)writestring
       /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(7)==  %% marquem on activem els gatells d'error per pentinar
      }ifelse
     }
     {  %% tot correcte i treballa en punts!
      %% fem un doble desat:
      %% desant la successió dels valors normalitzats de la URL per metadades i per consultar l'existència de la peça a les taules
      URLnorm 1 [ hies cvx exec /p ]  %% com que no la duu hi afegim les unitats
      put  %% a l'índex u hi va el valor de la mesura
      %% convertint els valors a unitats de punts PS, a punt per ser cridats per generar el PDF
      LINPSnorm 1 [ CONTEXTnorm begin hies cvx exec p end ] put
     }ifelse
    }
    {  %% no és cap numèric
%%S'ESDEVÉ si només hi posem les unitats o gir c p g tal com l'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=72&mesura=p&reng=/interlinia(3 72 g)
%% (8) Error: /stackunderflow in --copy-- Operand stack: 0 2
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=p%20&mesura=c%20&reng=/interlinia(p)
%% (4) (8) Error: /stackunderflow in --copy-- Operand stack: 0 2
     fotli (\\n\\n[#08] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &mesura=\\n\\n)writestring
     fotli (>> el primer valor no és cap numèric)writestring
     /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(8)==  %% marquem on activem els gatells d'error per pentinar
    }ifelse
   }ifelse
  }ifelse
 }if

 HIHAcos HIHAmesura hihaERROR not and and
 {  %% només té sentit si &cos= i &mesura= existeixen sense errors
  %% anotarem els errors de la URL progressivament, doncs &reng= necessita que &cos= i &mesura= siguin correctes per valorar amb rigor totes les peces

  HIHAreng
  {  %% si hi ha &reng=
   %% com que són petites ens podem permetre de regenerar les arrays de les taules de Mesures de Blancs, sempre bevent d'una mateixa font de dades
   <<  %% diccionari d'on tenim desades les taules de blancs amb els valors de cos i ample de cada peça
     /espai (mesuresBlancs_espais_quadratins_quadrats_pastells.ps) (r) file cvx exec
     /llengot (mesuresBlancs_llengots.ps) (r) file cvx exec
     /interlinia (mesuresBlancs_interlinies.ps) (r) file cvx exec
     /imposicio (mesuresBlancs_imposicions.ps) (r) file cvx exec
   >> /tBlancs exch def

   <<  %% diccionari on cada nom genèric de la peça de blancs té una descripció més literària
     /espai (Espais, Quadratins, Quadrats i Pastells)
     /llengot (Llengots)
     /interlinia (Interlínies)
     /imposicio (Imposicions)
   >> /tBlancsLiteraris exch def

   <<  %% diccionari d'on tenim desades les taules de blancs amb les instruccions de color per cada peça
     /espai (mesuresBlancs_espais_quadratins_quadrats_pastells_colorsRGB.ps) (r) file cvx exec
     /llengot (mesuresBlancs_llengots_colorsRGB.ps) (r) file cvx exec
     /interlinia (mesuresBlancs_interlinies_colorsRGB.ps) (r) file cvx exec
     /imposicio (mesuresBlancs_imposicions_colorsRGB.ps) (r) file cvx exec
   >> /tBlancsColor exch def

   /iX 0 def  %% índex de la peça dins la línia de composició (xibalet) necessari per explorar URLnorm LINPSnorm tBlancsColor

%%EFECTE token: ens permet ventar noms convertits en literals sense / però que tenen l'atribut d'executables i, llavors, s'ha d'anar en compte un cop desats
%%EPS filtrant la cadena de &reng= via token ens permet treballar amb literals sense /
   [  %% ara la variable té els valors dins una array
    rengVAL
    {
     token
     {
      exch
     }
     {
      exit
     }ifelse
    }loop
   ] /rengVAL exch def

   {  %% stopped
    %mark
%%+ filtrem pel cas que la variable estigui completament buida, amb només espais en blanc de teclat o amb la seva notació hexa %20 (que el navegador ja haurà convertit)
    rengVAL   %cvx exec  %% si som en una array i hi ha literals executables (via token), els executa!
    %counttomark

%%EFECTE token: l'array té literals executables
    length

    0 eq
    {
     %pop
%%S'ESDEVÉ si només hi han espais en blanc
%%http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&reng=%20%20%20%20%20%20%20&cos=6c&mesura=300
     fotli (\\n\\n[#09] ERROR DE SINTAXI AL VALOR DE LA VARIABLE &reng=\\n\\n)writestring
     fotli (>> és buida de valors, amb només espais en blanc de teclat o amb notació hexa %20)writestring
     /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(9)==  %% marquem on activem els gatells d'error per pentinar
    }
    {
     %cleartomark
     mark
%%+ filtrem errors de sintaxi de claus sense el / o valors fora de () i altres caràcters estranys
     rengVAL  %cvx exec  %% si som en una array i hi ha literals executables (via token), els executa!

%%EFECTE token: l'array té literals executables
     aload pop

%%+ filtrem errors de sintaxi d'aparellament de valors
     counttomark 2 mod 0 eq
     {  %% les dades de reng van aparellades
      %% no desem les dades del reng en un dict perquè es cavalcaran els noms de les claus
      ] /Areng exch def  %% desem les dades del reng en una array pel seu anàlisi

      [  %% muntem una array dels valors del reng amb els elements aparellats en arrays [ /nomDelBlanc (valor) ]
       Areng dup length 1 sub 0 exch 2 exch
       {
        1 index exch 2 getinterval exch
       }for
       pop
      ]

      {  %% forall per cadascuna de les arrays de cada peça amb els parells [ /nomDelBlanc (valor) ]
%%+ filtrem els errors de sintaxi dels noms de les Mesures de Blancs
       dup 0 get tBlancs exch known
       {  %% el nom està ben escrit
        %% no caldrà filtrar els errors de sintaxi dels valors de les Mesures de Blancs perquè llegeixValorsDvariables.ps només considera els valors útils per compondre
        %% ignorant tota la resta de caràcters sobrers, llavors només cadrà filtrar si els valors de la peça existeixen dins les taules de Mesures de Blancs
        %% i si no exiteix cal decidir què fem: saltar al valor més proper (quin sentit té?) o escriure l'error i no generar el PDF amb el reng

        /AparellMB exch def  %% desem l'array del parell [ /nomDelBlanc (valor) ] que li serveix el forall
        mark
        AparellMB 1 get  %% l'string amb els valors de la peça que, un cop analitzats, es convertiran en l'array hies
        (llegeixValorsDvariables.ps) (r) file cvx exec  %% és més eficient executar-ho com a fitxer extern o dins d'un procediment definit?
        cleartomark

        %% la peça existeix dins les taules de Mesures de Blancs?
        %% com que ja tenim normalitzades les dades tal i com estan descrites a la taula, això és: el cos actuarà d'índex dins l'array de la taula
        %% i l'ample s'haurà de trobar dins d'aquest array localitzat per l'índex (si localitza un null voldrà dir que l'array d'amples per aquest cos no existeix)
        %% ens cal doncs tenir aquestes dues dades, cos i ample, amb les mateixes unitats que s'expressen a la taula (descrites a l'índex 0 de cadascuna)
        %% això pot significar que s'hagin descrit les peces del reng cos/mesura en unitats diferents al que haurem de consultar a la taula i caldrà normalitzar-ho
        %% un cop comprovat que la peça existeix a la taula, cal bastir les arrays /URLnorm i /LINPSnorm
        %% fent les conversions pertinents a punts de Pica PS i aplicar les intruccions de gir si existeixen per tal es pugui executar un resultat gràfic en PDF

%%+ el valor de la variable &cos= i el cos de la peça (unificant les unitats a punts) coincideixen?
        mark hies  %% aquest és el resultat de l'algorisme llegeixValorsDvariables.ps
        userdict /girem false put  %% gatell lligat a CONTEXTerrors per saber si hem aplicat g capgirant els valors a l'stack: el cos passa al lloc de l'ample i viceversa
        CONTEXTerrors begin {cvx exec}forall end  %% executant els valors hi quedarà el cos i/o l'ample de la peça, sempre en punts
        counttomark 2 eq
        {  %% si té dos elements
	 userdict /girem get
	 {  %% si s'ha girat la peça
          pop hies 0 get  %% ens assegurem que no ha mutat d'unitats, tornant a pescar el valor original del cos de la peça (que actua d'índex) i que ara serà l'ample
          /icosGirat exch def  %% aquest serà el nou ample de la peça però a la taula és el cos que haurem d'anar a buscar per saber si existeix
	 }
	 {
	  pop
	 }ifelse
         URLnorm 0 get  %% array del cos i unitats que determina la variable &cos= per totes les peces de la línia
         CONTEXTerrors begin {cvx exec}forall end  %% executant el valor del cos a punts
         eq  %% coincideix?
         exch pop
        }
        {  %% si només n'hi ha un
         userdict /girem get
         {  %% si hi ha una instrucció de gir i la peça només té 1 sol element
%%S'ESDEVÉ si es compleix el que diu el comentari, sempre que existeixin aquests valors a la taula, tal i com podem veure a l'exemple
%%http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&reng=/imposicio%20(8c%20g)%20&cos=6c&mesura=300
%% (10) Error: /ioerror in --flushfile--
          fotli (\\n\\n[#10] ERROR EN EL GIR D\\'UNA PEÇA DE LA VARIABLE &reng=\\n\\n)writestring
          fotli (>> la peça… )writestring
          fotli (/)writestring fotli AparellMB 0 get 32 string cvs writestring
          fotli ( [ )writestring
          hies
          {
           32 string cvs fotli exch writestring
           fotli ( ) writestring
          }forall
          fotli (])writestring
          fotli ( …només duu el valor d\\'ample i li manca el valor del cos per tal que la instrucció de gir… g …pugui aplicar-se)writestring
          /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(10)==  %% marquem on activem els gatells d'error per pentinar
	  userdict /girem false put  %% i desactivarem el gatell
	 }if
         pop pop true  %% coincideix segur perquè és &cos= qui mana
        }ifelse

        {  %% coincideixen
%%+ la peça a compondre existeix dins la taula?

         tBlancs AparellMB 0 get dup
%%EFECTE token: aquí tenim el literal d'una peça (extreta amb token sense /) que té l'atribut d'executable i llavors, un cop desat a /ARAtaula, ja s'executa sense més
         cvlit  %% per això aquí la forcem a literal perquè no s'executi quan la tornem a alliberar de la variable
	 /ARAtaula exch def  %% podrem referenciar la taula si es produeixen errors 
         get  %% aquí la taula de peces de blanc a cercar
         dup 0 get  %% literal de les unitats amb què ens cal localitzar el cos
         URLnorm 0 get  %% array del cos i unitats que determina la variable &cos= per totes les peces de la línia
         dup 1 get 3 -1 roll eq
         {  %% si les unitats de la variable &cos= i les unitats dels cossos de la taula coincideixen el seu valor ja serveix com a índex per cercar els amples a la taula
          0 get  %% extraiem el valor de &cos=
         }
         {  %% si les unitats de la variable &cos= i les unitats dels cossos de la taula NO coincideixen
          CONTEXTindex begin {cvx exec}forall end  %% llavors el valor de la variable &cos= s'ha de convertir a les unitats dels cossos de la taula
         }ifelse
         userdict /girem get
         {  %% si hem aplicat g serà el cos original (el nou ample) que ha de treballar com a índex
	  pop
	  icosGirat
         }if
         /icos exch def  %% treballarà com a índex
         dup length icos

	 le  %% primer assegurem que no som més enllà de l'índex permès
         {  %% la peça d'aquest cos va més enllà de l'índex permès, llavors no existeix
%%S'ESDEVÉ si es compleix el que pòsa el comentari o tal com pot veure's a l'exemple
%%http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&reng=/imposicio%20(61c%20)%20&cos=61c&mesura=300
          fotli (\\n\\n[#11] ERROR EN EL VALOR DEL COS D\\'UNA PEÇA DE LA VARIABLE &reng=\\n\\n)writestring
          fotli (>> el cos… )writestring
          fotli icos 32 string cvs writestring
          fotli ( …de la peça… /)writestring
          fotli ARAtaula 32 string cvs writestring
          fotli ( [ )writestring
          hies
          {
           32 string cvs fotli exch writestring
           fotli ( ) writestring
          }forall
          fotli (] …no existeix perquè excedeix la taula… )writestring
          fotli tBlancsLiteraris ARAtaula get writestring
          pop
          /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(11)==  %% marquem on activem els gatells d'error per pentinar
         }
         {  %% potser pot existir
          icos get dup null eq 1 index type /nametype eq or
          {  %% la peça d'aquest cos no existeix
           pop
%%S'ESDEVÉ si passa el que s'explica al missatge o a l'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=19&mesura=300&reng=/espai(19 36)
           fotli (\\n\\n[#12] ERROR EN EL VALOR DEL COS D\\'UNA PEÇA DE LA VARIABLE &reng=\\n\\n)writestring
           fotli (>> el cos… )writestring
           fotli icos 32 string cvs writestring
           fotli ( …de la peça… )writestring
           fotli (/)writestring fotli ARAtaula 32 string cvs writestring
           fotli ( [ )writestring
           hies
           {
            32 string cvs fotli exch writestring
            fotli ( ) writestring
           }forall
           fotli (])writestring
           fotli ( …no existeix a la taula… )writestring
           fotli tBlancsLiteraris ARAtaula get writestring
           /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(12)==  %% marquem on activem els gatells d'error per pentinar
          }
          {  %% el cos existeix i ara comprovem si l'ample existeix
           dup /pecesDELcos exch def  %% desem l'array d'amples de peces del cos existents en aquesta mesura de blancs
           0 get /uAmples exch def  %% amb quines unitats treballa l'array d'amples?
           %% cerquem quin és el valor /vPample i la unitat /uPample té l'ample de la peça
           userdict /girem false put  %% gatell lligat a CONTEXTindexAMPLE per saber si hem aplicat g i hem girat els valors cos/ample dins l'array
           [  %% primer apliquem /g, si existeix, de manera que invertim l'ordre dels valors, fent que el cos sigui l'ample i viceversa amb unitats incloses
            CONTEXTindexAMPLE begin hies {cvx exec}forall
           ]  %% un cop aplicat aquest context les unitats queden intactes
           dup length 1 eq
           {  %% si només duu 1 sol element vol dir que l'ample no duu unitats, llavors són punts
            dup 0 get /vPample exch def /uPample /p def
           }
           {  %% si duu més d'1 element
            dup length 2 eq
            {
             dup 1 get type /nametype eq
	     {  %% el segon element són les unitats
	      dup 0 get /vPample exch def
	      dup 1 get /uPample exch def
             }
             {  %% són dos valors enters de cos i ample
              userdict /girem get
	      {  %% si ja hem aplicat el gir el primer valor és l'ample a cercar
	       dup 0 get /vPample exch def
	      }
	      {  %% si no hem aplicat el gir, el segon valor és l'ample a cercar
	       dup 1 get /vPample exch def
	      }ifelse
	      /uPample /p def  %% no duu unitats, doncs treballa en punts
             }ifelse
	    }
            {  %% duu més de 2 elements
             dup length 3 eq
             {  %% cos o ample duu unitats
              dup 2 get type /nametype eq  %% l'array ja pot venir girada!
	      {  %% l'ample duu unitats
	       userdict /girem get
	       {  %% si ja hem aplicat el gir el primer valor és l'ample a cercar
	        dup 0 get /vPample exch def
	        /uPample /p def  %% no duu unitats doncs treballa en punts
	       }
	       {  %% si no hem aplicat el gir, el segon valor és l'ample a cercar
	        dup 1 get /vPample exch def
	        dup 2 get /uPample exch def
	       }ifelse
	      }
              {  %% el cos duu unitats
	       userdict /girem get
	       {  %% si ja hem aplicat el gir el primer valor és l'ample a cercar
	        dup 0 get /vPample exch def
	        dup 1 get /uPample exch def
               }
               {  %% si no hem aplicat el gir, el segon valor és l'ample a cercar
	        dup 2 get /vPample exch def
	        /uPample /p def  %% no duu unitats, doncs treballa en punts
	       }ifelse
              }ifelse
	     }
             {  %% 4 valors, cos amb unitats i ample amb unitats
              userdict /girem get
              {  %% si ja hem aplicat el gir el primer valor és l'ample a cercar
	       dup 0 get /vPample exch def
	       dup 1 get /uPample exch def
              } 
              {  %% si no hem aplicat el gir, el tercer valor és l'ample a cercar
	       dup 2 get /vPample exch def
	       dup 3 get /uPample exch def
	      }ifelse
	     }ifelse
            }ifelse
           }ifelse
           %% tot seguit ens cal saber si les unitats d'ample del valor de la peça coincideixen amb les unitats de l'array d'amples de la taula
           uPample uAmples ne
           {  %% si no són iguals hem de transformar les unitats d'uPample al que ens mana uAmples
            CONTEXTindex begin vPample uPample cvx exec end  %% si uPample són punts es passen a cíceros i viceversa
            /vPample exch def  %% actualitzem el valor d'ample de la peça que ja podrem cercar dins l'array d'amples de la taula
           }if
           /pMesura exch def  %% array amb el valor cos ample i unitats (amb la rotació g aplicada, si hi és) a punt per desar a /URLnorm i /LINPSnorm
           /iample 0 def  %% aquest índex després en serveix per anar a pescar el color de la peça (i més endavant la seva imatge)
           pecesDELcos
           {  %% forall per comprovar que l'ample hi és, llavors la peça existeix
            vPample eq
            {
	     /Ahies true def
	     exit
	    }
	    {
	     /Ahies false def
	    }ifelse
	    iample 1 add /iample exch def
	   }forall
           Ahies
           {  %% aquí desem a /URLnorm i /LINPSnorm els valors de la peça dins el reng
            URLnorm  %% a l'índex 2 hi va, peça a peça per ordre de compòsició, una array amb el literal de la peça i una array amb els valors i unitats normalitzades
            dup 2 get dup length dup /araVa exch def 1 add array dup 3 -1 roll 0 exch putinterval  %% ampliem l'array del reng per una peça més

%ARAtaula
%pMesura
            dup araVa [ ARAtaula pMesura ] put 2 exch put  %% desem a /URLnorm dins l'array del reng la nova peça
            %% aplicarem /CONTEXTnorm per generar una array amb valors a punts de Pica Postscript per composar a PDF la línia de blancs
	    [ CONTEXTnorm begin
             [  %% abans ens cal que tots els valors duguin la unitat de /p si s'ha omès
	      pMesura
              %% gatell per saber si hem ventat un valor, quan sigui a true i haguem llegit de nou un altre numèric /integertype voldrà dir que li manquen les unitats /p
              /esVAL false def
              {  %% forall que explora una array amb els valors de cos i ample d'una peça i detecta si a cap dels valors li falten les unitats /p afegint-les
               dup type /integertype eq
               {
                esVAL
                {
                 /p exch
                }if
                /esVAL true def  %% gatell per saber si hem fet un valor
               }
               {
                /esVAL false def  %% gatell per saber si hem fet un valor
               }ifelse
              }forall
              esVAL
              {
               /p
              }if
             ]  %% tanquem l'array de nou
             {cvx exec}forall end
            ]  %% en aquesta array hi ha cos i ample (per aquest ordre!) en punts de Pica PS de la peça que es compon al reng
            %% a l'índex 2 hi ha el paquet, peça a peça per ordre de composició, dins una array amb:
%%EPS què passa si és buida?
	    LINPSnorm dup 2 get dup length dup /araVa exch def 1 add array dup 3 -1 roll 0 exch putinterval dup  %% array ampliada a punt de rebre la peça següent
            4 -1 roll  %% les instruccions rectfill (alt x ample!) amb punts de Pica PS (quan hi hagi la imatge digitalitzada hi podrien anar els paràmetres image)
            %% el color RGB amb que cal pintar la peça (quan hi hagi la imatge digitalitzada hi podria anar el path al fitxer)
            %% el pesquem cridant la taula de colors que toca amb els mateixos índex de cos i ample amb els que hem localitzat la peça
            tBlancsColor ARAtaula get icos get iample get
	    exch 2 array astore  %% empaquetem color i mides y/x de la peça
	    araVa exch put 2 exch put  %% ho desem a l'array ampliada i aquesta dins LINPSnorm
	   }
	   {
%%S'ESDEVÉ com descriu el missatge d'error i la URL d'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=36&mesura=300&reng=/imposicio(36 72)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=36&mesura=300&reng=/espai(6c p)
            fotli (\\n\\n[#13] ERROR EN EL VALOR DE L\\'AMPLE D\\'UNA PEÇA DE LA VARIABLE &reng=\\n\\n)writestring
            fotli (>> l\\'ample de la peça… )writestring
            fotli (/)writestring fotli AparellMB 0 get 32 string cvs writestring
            fotli ( [ )writestring
            hies
            {
             32 string cvs fotli exch writestring
             fotli ( ) writestring
            }forall
            fotli (])writestring
	    fotli ( …no existeix a la taula d\\'amples del cos… )writestring
            fotli cosVAL writestring
	    fotli (\\n\\n)writestring
            /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(13) ==  %% marquem on activem els gatells d'error per pentinar
           }ifelse  %% l'ample hi és per aquest cos?
          }ifelse  %% però el cos existeix?
         }ifelse  %% el cos no supera el rang de la taula
        }
        {  %% si no coincideix
%%S'ESDEVÉ com descriu el missatge d'error i la URL d'exemple
%%http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=36&mesura=300&reng=/imposicio(36c%2072)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96&mesura=6&reng=/imposicio(6c96ppg)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96&mesura=6&reng=/imposicio(6c96pGg)
         fotli (\\n\\n[#14] ERROR EN EL VALOR D\\'UNA PEÇA A LA VARIABLE &reng=\\n\\n)writestring
         fotli (>> el valor de la variable &cos= )writestring
         fotli cosVAL writestring
         fotli ( …no coincideix amb el cos de la peça… )writestring
         fotli (/)writestring fotli AparellMB 0 get 32 string cvs writestring
         fotli ( [ )writestring
         hies
         {
          32 string cvs fotli exch writestring
          fotli ( ) writestring
         }forall
         fotli (])writestring
         fotli ( …de la variable &reng=\\n\\n)writestring
         /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(14)==  %% marquem on activem els gatells d'error per pentinar
        }ifelse
       }
       {  %% el nom està mal escrit
%%S'ESDEVÉ com descriu el missatge d'error i la URL d'exemple
%%http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=36&mesura=300&reng=/iMposicio(36%2072)
        fotli (\\n\\n[#15] ERROR DE SINTAXI EN EL NOM D\\'UNA PEÇA A LA VARIABLE &reng=\\n\\n)writestring
	fotli (>> el nom de la peça… /)writestring
        0 get 128 string cvs fotli exch writestring
	fotli ( …està mal escrit)writestring
        /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(15)==  %% marquem on activem els gatells d'error per pentinar
       }ifelse
       iX 1 add /iX exch def  %% índex de peces dins la línia de composició
      }forall  %% per cadascuna de les arrays amb els parells /nomDelBlanc (valor)
     }
     {  %% les dades de reng van desaparellades
%%S'ESDEVÉ si hi ha algun dels errors de sintaxi descrits al missatge tal i com demostra l'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=36&mesura=300&reng=/espai(36)72
      fotli (\\n\\n[#16] ERROR DE SINTAXI EN ALGUN DELS VALORS DE LA VARIABLE &reng=\\n\\n)writestring
      fotli (>> hi ha alguna peça de Mesures de Blancs desaparellada: valor fora del parèntesi, nom sense el seu valor o viceversa)writestring
      cleartomark
      /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(16)==  %% marquem on activem els gatells d'error per pentinar
     }ifelse
    }ifelse  %% si &reng= és buit de dades?
   }stopped
   {
%%S'ESDEVÉ si hi ha algun dels errors de sintaxi descrits al missatge o a l'exemple
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=36&mesura=300&reng=/espai(6c C)
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?mesura=13c&cos=6&reng=/llengot (6c)/espai(1/4)/espai(1/4)/espai(1/3) /espai(1/2) /espai(12 1/2 g) /llengot(5c) /espai(18)
    fotli (\\n\\n[#17] ERROR DE SINTAXI EN ALGUN DELS VALORS DE LA VARIABLE &reng=\\n\\n)writestring
    fotli (>> hi ha algun nom d\\'alguna peça de Mesures de Blancs sense el… / …o algun dels seus valors no duu correctament els parèntesi… \(\) …o hi ha caràcters estranys i/o repetits a la sintaxi d\\'aquesta variable)writestring
    /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
   }if
  }if  %% si hi ha &reng=
 }if  %% només té sentit si &cos= i &mesura= existeixen sense errors


%%Filtrem els errors de mesura en la composició, això és:
 %% la línia de peces compostes a la variable &reng= sumen el valor exacte de la variable &mesura= ?
 <<
   /p
   {
    fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    aValua dup 12 idiv dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring 
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els punts a mm
    aValua .3759 mul 32 string cvs fotli exch writestring
    fotli ( mm\\n) writestring
   }
   /c
   {
    fotli ( cíceros Didot \()writestring
    aValua 12 mul 32 string cvs fotli exch writestring  %% transformem els cíceros a punts
    fotli ( punts\)\\n)writestring
    %% transformem els cíceros a mm
    aValua 12 mul .3759 mul 32 string cvs fotli exch writestring
    fotli ( mm\\n) writestring
   }
 >> /unitatsLiteraries exch def
 /desviacioPermesa 1 def  %% aquest és el llindar per valorar de si acceptem generar el PDF gràfic (ara en punts de Pica PS)
 /sumemAmpleReng 0 def
 LINPSnorm 2 get


 dup length 0 eq
 {  %% no estem segurs que cap vegada passem per aquí, doncs abans ja hauríem d'haver detectat algun error?
  pop /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però en farem un anotant els errors)
 }
 {
%%ATENCIÓ: les peces del &reng= com /imposicio(8c) dins a LINPSnorm duen només el valor de l'ample (a punts PS) però podrien dur els 2 (cos/mesura) ja girats
  %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=72&mesura=151&reng=/espai(36 72g)/interlinia(1p6Cg)/llengot(18P6Cg)/imposicio(8c)
  {  %% forall sumador del total d'amples de cadascuna de les peces del &reg=
   1 get  %% array amb 1 o 2 valors (el darrer valor sempre serà l'ample)
   dup length 1 eq
   {
    0 get
   }
   {
    1 get
   }ifelse
   sumemAmpleReng add /sumemAmpleReng exch def
  }forall
  %% i comprovem si quadra amb el valor de &mesura= (sempre en punts PS!)
  sumemAmpleReng LINPSnorm 1 get cvx exec
  2 copy 2 array astore /gAlga exch def  %% per si cal
  sub dup /llindaR exch def  %% valor del llindar de diferència respectant el signe
  abs dup 0 eq exch desviacioPermesa le or
  {  %% la suma d'amples de &reng= vs &mesura= fa la mida exacta en punts PS o NO supera la /desviacioPermesa?
%%S'ESDEVÉ segons el que descriu el missatge i la URL d'exemple
   %% aquesta URL treballa amb totes les peces de Mesures de Blancs
   %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=775P&reng=/espai(48p72PG)/interlinia(1%206cG)/llengot(6p%206Cg)/imposicio(60c)
   %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96p&mesura=72P&reng=/imposicio(6c96pG)
   fotli (Sou dins el llindar de la desviació permesa... )writestring
   fotli llindaR 32 string cvs writestring
   fotli ( ...punts de Pica PS\\n\\n)writestring
   % gAlga llindaR pstack elLLINDAResZEROoMAXIMd1puntDpicaPS!
  }
  {  %% té un valor més enllà de la /desviacioPermesa!
   %gAlga llindaR pstack LLINDARdeMESd1PUNT!
   llindaR 0 lt
   {  %% la suma d'amples de les peces del &reng= és més petita que la &mesura= de línia
%%S'ESDEVÉ segons el que descriu el missatge i la URL d'exemple
    %% aquesta URL treballa amb totes les peces de Mesures de Blancs
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=792P&reng=/espai(48p72PG)/interlinia(1%206cG)/llengot(6p%206Cg)/imposicio(60c)
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=22P&reng=/interlinia(1%206cG)/llengot(6p%206Cg)/interlinia(1%206cG)/llengot(6p%206Cg)/interlinia(1%206cG)/llengot(6p%206Cg)
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96p&mesura=73P&reng=/imposicio(6c96pG)

    fotli ([#18] LA COMPOSICIÓ DE LES PECES DEL &reng= NO ARRIBA A L\\'AMPLE DE LA VARIABLE &mesura=\\n\\n)writestring

    fotli (>> la línia de composició &mesura=\\n)writestring  %% en punts/cíceros Didot
    URLnorm 1 get
    {  %% forall pel valor i el literal de les unitats originals cíceros/punts Didot
     dup type /integertype eq
     {  %% és el valor de &mesura=
      dup /araMesura exch def
      32 string cvs fotli exch writestring
     }
     {  %% són les unitats (que aquí sempre hi són malgrat no hi siguin a la URL) que s'han fet servir a la URL expressades de manera més entenedora
      araMesura /aValua exch def
      unitatsLiteraries exch get cvx exec  %% les convertim, entre parèntesi, si a la URL van en cíceros les passem a punts i viceversa
     }ifelse
    }forall
    %% valor de &mesura= en punts de Pica PS
    gAlga 1 get  %% a l'índex 1 hi ha el valor de &mesura= en punts de Pica PS
    32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    %% sumades les mesures de totes les peces del &reng=
    fotli (\\n>> sumades les mesures de totes les peces del &reng=\\n)writestring  %% en punts/cíceros Didot
    gAlga 0 get  %% a l'índex 0 hi ha la suma d'amples de les peces del &reng= en punts de Pica PS
    dup 100000 mul truncate 100000 div  %% considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    dup 1.06554  %% del valor d'equivalència d'1 punt Didot a punt de Pica considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    div cvi dup dup /rpDidot exch def  %% en punts Didot exactes
    32 string cvs fotli exch writestring fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    dup 12 idiv dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring 
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els cíceros a mm
    fotli rpDidot .3759 mul 32 string cvs writestring
    fotli ( mm\\n) writestring
    gAlga 0 get  %% a l'índex 0 hi ha la suma d'amples de les peces del &reng= en punts de Pica PS
    32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    %% el valor absolut de la resta dels dos valors de la gAlga en 3 unitats
    fotli (\\n>> hi manca encara:\\n)writestring
    gAlga 1 get  %% a l'índex 1 hi ha el valor de &mesura= en punts de Pica PS
    gAlga 0 get  %% a l'índex 0 hi ha la suma d'amples de les peces del &reng= en punts de Pica PS
    sub dup /dpPica exch def
    dup 100000 mul truncate 100000 div  %% considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    dup 1.06554  %% del valor d'equivalència d'1 punt Didot a punt de Pica considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    div %cvi
    dup dup /rpDidot exch def  %% en punts Didot exactes
    32 string cvs fotli exch writestring fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    dup
    cvi 12 idiv dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring 
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els cíceros a mm
    fotli rpDidot .3759 mul 32 string cvs writestring
    fotli ( mm\\n) writestring
    dpPica 32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    %% el valor de la desviació en 3 unitats
    fotli (\\n>> el màxim llindar d\\'error permès, és de:\\n)writestring
    desviacioPermesa dup /dpPica exch def
    dup 100000 mul truncate 100000 div  %% considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    dup 1.06554  %% del valor d'equivalència d'1 punt Didot a punt de Pica considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    div dup dup /rpDidot exch def  %% en punts Didot exactes
    32 string cvs fotli exch writestring fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    dup 12 div dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els cíceros a mm
    fotli rpDidot .3759 mul 32 string cvs writestring
    fotli ( mm\\n) writestring
    dpPica 32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring


    false
    {  %% potser ens caldrà?
     /AMPLEreng 0 def
     URLnorm 2 get
     {  %% forall per sumar tots els amples amb les unitats de la URL
      1 get dup dup length 1 sub dup /vaFins exch def get type /nametype eq
      {  %% duu unitats
       vaFins 1 sub 2 getinterval
       <</p {} /c{12 mul}>> begin
       {
        cvx exec
       }forall
       end
       AMPLEreng add /AMPLEreng exch def  %% sumem els punts Didot
      }
      {  %% és l'ample de la peça i són punts
       vaFins get AMPLEreng add /AMPLEreng exch def  %% sumem els punts Didot
      }ifelse
     }forall

     fotli AMPLEreng 32 string cvs writestring
     AMPLEreng /aValua exch def
     unitatsLiteraries /p get cvx exec
     pstack AQUIelsVALORSumatsDE&reng=
    }if

    /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
   }
   {  %% la suma d'amples de les peces del &reng= és més gran que la &mesura= de línia
    %pstack SUPERAelLLINDARiSOBREPASSA
%%S'ESDEVÉ si passa alguna de les coses que es descriuen al missatge
    %% aquesta URL treballa amb totes les peces de Mesures de Blancs
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=774P&reng=/espai(48p72PG)/interlinia(1%206cG)/llengot(6p%206Cg)/imposicio(60c)
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=1c&reng=/interlinia(1%206cG)/llengot(6p%206Cg)/interlinia(1%206cG)/llengot(6p%206Cg)/interlinia(1%206cG)/llengot(6p%206Cg)
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96p&mesura=69P&reng=/imposicio(6c96pG)
    %% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=96p&mesura=6cp&reng=/imposicio(6c96pG)

    fotli ([#19] LA COMPOSICIÓ DE PECES DEL &reng= SUPERA L\\'AMPLE DE LA VARIABLE &mesura=\\n\\n)writestring

    fotli (>> la línia de composició &mesura=\\n)writestring  %% en punts/cíceros Didot
    URLnorm 1 get
    {  %% forall pel valor i el literal de les unitats originals cíceros/punts Didot
     dup type /integertype eq
     {  %% és el valor de &mesura=
      dup /araMesura exch def
      32 string cvs fotli exch writestring
     }
     {  %% són les unitats (que aquí sempre hi són malgrat no hi siguin a la URL) que s'han fet servir a la URL expressades de manera més entenedora
      araMesura /aValua exch def
      unitatsLiteraries exch get cvx exec  %% les convertim, entre parèntesi, si a la URL van en cíceros les passem a punts i viceversa
     }ifelse
    }forall

    %% valor de &mesura= en punts de Pica PS
    gAlga 1 get  %% a l'índex 1 hi ha el valor de &mesura= en punts de Pica PS
    32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    %% sumades les mesures de totes les peces del &reng=
    fotli (\\n>> sumades les mesures de totes les peces del &reng=\\n)writestring  %% en punts/cíceros Didot
    gAlga 0 get  %% a l'índex 0 hi ha la suma d'amples de les peces del &reng= en punts de Pica PS
    dup 100000 mul truncate 100000 div  %% considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    dup 1.06554  %% del valor d'equivalència d'1 punt Didot a punt de Pica considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    div cvi dup dup /rpDidot exch def  %% en punts Didot exactes
    32 string cvs fotli exch writestring fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    dup 12 idiv dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring 
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els cíceros a mm
    fotli rpDidot .3759 mul 32 string cvs writestring
    fotli ( mm\\n) writestring
    gAlga 0 get  %% a l'índex 0 hi ha la suma d'amples de les peces del &reng= en punts de Pica PS
    32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    %% el valor absolut de la resta dels dos valors de la gAlga en 3 unitats
    fotli (\\n>> excedeix en:\\n)writestring
    gAlga 1 get  %% a l'índex 1 hi ha el valor de &mesura= en punts de Pica PS
    gAlga 0 get  %% a l'índex 0 hi ha la suma d'amples de les peces del &reng= en punts de Pica PS
    sub abs dup /dpPica exch def
    dup 100000 mul truncate 100000 div  %% considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    dup 1.06554  %% del valor d'equivalència d'1 punt Didot a punt de Pica considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    div %cvi
    dup dup /rpDidot exch def  %% en punts Didot exactes
    32 string cvs fotli exch writestring fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    dup
    cvi 12 idiv
    dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring 
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els cíceros a mm
    fotli rpDidot .3759 mul 32 string cvs writestring
    fotli ( mm\\n) writestring
    dpPica 32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    %% el valor de la desviació en 3 unitats
    fotli (\\n>> el màxim llindar d\\'error permès, és de:\\n)writestring
    desviacioPermesa dup /dpPica exch def
    dup 100000 mul truncate 100000 div  %% considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    dup 1.06554  %% del valor d'equivalència d'1 punt Didot a punt de Pica considerem només els 5 primers decimals per arrodonir millor les conversions de Pica PS a Didot
    div dup dup /rpDidot exch def  %% en punts Didot exactes
    32 string cvs fotli exch writestring fotli ( punts Didot \()writestring
    %% transformem els punts a cíceros i la resta a punts si no dóna exacte
    dup 12 div dup fotli exch 32 string cvs writestring
    fotli ( cíceros) writestring
    12 mul sub dup 0 eq
    {
     pop fotli (\)\\n)writestring
    }
    {
     fotli ( amb )writestring
     32 string cvs fotli exch writestring
     fotli ( punts\)\\n)writestring
    }ifelse
    %% transformem els cíceros a mm
    fotli rpDidot .3759 mul 32 string cvs writestring
    fotli ( mm\\n) writestring
    dpPica 32 string cvs fotli exch writestring fotli ( punts de Pica PS\\n)writestring

    /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
   }ifelse
  }ifelse
 }ifelse
}
{  %% almenys en falla 1
 /hihaERROR true def  %% NO generarem el PDF gràfic amb el reng (però pot ser en farem un anotant els errors)
%%NO hi pot haver cap flux d'elements a l'stack fora dels que s'escriuen a tOU, doncs sinó ens fa petar el prompt de JS!
%(18)==  %% marquem on activem els gatells d'error per pentinar
%%S'ESDEVÉ si passa alguna de les coses que es descriuen al missatge
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&%20&reng=/interlinia(%20%20%20)
 fotli ([#00] ERROR DE SINTAXI AL NOM DE LES VARIABLES:\\n\\n)writestring

 HIHAcos not
 {
  fotli (&cos=\\n)writestring
 }if

 HIHAmesura not
 {
  fotli (&mesura=\\n)writestring
 }if

 HIHAreng not
 {
  fotli (&reng=\\n)writestring
 }if
 fotli (\\n>> o no l\\'hem escrita, o no l\\'hem escrita bé, o no hem escrit el… = …o no l\\'hem escrit enganxat a la variable, o no hem escrit el… & …o la variable no té cap valor, ni tant sols un espai en blanc)writestring
}ifelse


hihaERROR
{  %% amb errors
%%S'ESDEVÉ amb totes les peces de Mesures de Blancs
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?&cos=6c&mesura=792P&reng=/espai(48p72PG)/interlinia(1%206cG)/llengot(6p%206Cg)/imposicio(60c)

 % pstack SIhihaERRORcomseguim?
 fotli (\\n\\n________________________T E N I U   E R R O R S________________________\\n\\nSi prems…  [ Cancel·la ]  …et mantindràs en aquesta mateixa pàgina en blanc\\n\\nSi prems…  [ D\\'acord ]  …s\\'obrirà un PDF amb els errors transcrits en una nova pestanya del navegador)writestring
 fotli dup flushfile closefile

 %% fem que surti l'error al prompt de la web
 tOU
 (\000) search
 {  %% filtrem els \000 de la cua del buffer de 2048
  exch pop exch pop
 }
 {  %% si esgotessim el buffer ho detectaríem per aquí
  TENIMunERRORamb_toU
 }ifelse

% pop (\(\\n\\nEM VEUS?\\n\\n\))  %450 9 getinterval pstack QUECONYPASSAAQUI?

 =  %% treu tot el contingut de la cadena interpretant els retorns de carro correctament
%  ==  %treu la cadena amb el () sense interpretar el seu interior

 %% aquí podem treballar sempre en A4 horitzontal
 <</PageSize[842 595]>>setpagedevice
 /margeS 30 def  %% valor per cadascun des 4

 842 margeS 2 mul sub  %% A4 horitzontal
 /Xpossible exch def

 (/usr/share/fonts/truetype/hack/Hack-Regular.ttf)
 findfont
 dup length dict begin
 {
  1 index /FID ne
  {def}{pop pop}ifelse
 }forall
 /Encoding systemdict /EncodingDirectory get /WinAnsiEncoding get def
 currentdict end
 /mono_WA exch definefont pop

 %% mesurem l'ample dels glifs a 1 punt de cos
 /mono_WA 1 selectfont
 0 0 moveto (i) stringwidth pop /ampleA1puntDcos exch def

 tOU
 (Si prems) search
 {  %% filtrem des dels missatges de gestió del prompt fins els \000 de la cua del buffer de 2048
  exch pop exch pop
 }
 {  %% si esgotessim el buffer ho detectaríem per aquí
  TENIMunERRORamb_toU
 }ifelse

 %% lector/componedor dels caràcters que es codifiquen en simple, doble i triple octet i per destriar \n com a retorn de carro i \' com apòstrof
 (decodificaWinAnsiEncoding_a1i2octets.ps)
 (r) file cvx exec

 %% afegim la darrera cadena amb la URL executada dins l'array
 AliniesD1solOctet dup length dup /araVa exch def 1 add array dup 3 -1 roll 0 exch putinterval
 dup araVa laURL put /AliniesD1solOctet exch def

 /lamesllarga 0 def  %% detectem quina és la línia més llarga
 AliniesD1solOctet
 {  %% forall
  length dup lamesllarga gt
  {
   /lamesllarga exch def
  }
  {
   pop
  }ifelse
 }forall
 
 %% l'ample de pàgina imprimible dividit pel producte del nombre de glifs de la línia més llarga per l'ample d'1 glif a 1 punt
 %% és = al coS perquè la línia més llarga faci exactament l'ample imprimible de pàgina
 Xpossible  %% l'ample imprimible de pàgina
 lamesllarga  %% nombre de glifs de la línia més llarga
 ampleA1puntDcos  %% l'ample d'1 glif a 1 punt
 mul div
 /coS exch def
 
 /mono_WA findfont coS scalefont setfont
 0 0 0 setrgbcolor
 /iL coS 1.12 mul def
 /caP %A4_A0 iFormat get 1 get
 595 margeS sub iL sub def  %% A4 horitzontal

 1 0 0 setrgbcolor  %% vermell d'error

 AliniesD1solOctet
 {  %% forall
  margeS caP moveto show
  caP iL sub /caP exch def
 }forall

 caP iL sub /caP exch def
 margeS caP moveto

 %litA4_A0 iFormat get show

 showpage
}
{  %% sense errors
%%S'ESDEVÉ amb totes les peces de Mesures de Blancs
%% http://localhost/www.ub.edu/tallerdetipografia/caixista/componedoraRIMDA00.php?cos=6c&mesura=775P&reng=/espai(48p72PG)/interlinia(1%206cG)/llengot(6p%206Cg)/imposicio(60c)
	% pstack sinohihaerrorCOMSEGUIM?
 fotli (      E L   R E N G   S \\' H A   C O M P O S T   C O R R E C T A M E N T\\n\\nSi prems…  [ Cancel·la ]  …et mantindràs en aquesta mateixa pàgina en blanc\\n\\nSi prems…  [ D\\'acord ]  …s\\'obrirà el PDF amb la composició en una nova pestanya del navegador)writestring
 fotli dup flushfile closefile

 %% fem que surti l'error al prompt de la web
 tOU
 (\000) search
 {  %% filtrem els \000 de la cua del buffer de 2048
  exch pop exch pop
 }
 {  %% si esgotessim el buffer ho detectaríem per aquí
  TENIMunERRORamb_toU
 }ifelse

 =  %% treu tot el contingut de la cadena interpretant els retorns de carro correctament
 %% == treu la cadena amb el () sense interpretar el seu interior

 %% en funció del valor més gran de &mesura= o &reng= triarem DIN i orientació adequada a partir d'un A4
 /margeS 30 def  %% valor fix per cadascun des 4

 LINPSnorm dup 1 get 0 get  %% mesura de línia
 /falinia exch def  %% el valor de &mesura= no cal comparar-lo amb &reng= perquè només poden diferir en la desviació permesa del llindar /desviacioPermesa
 0 get 0 get  %% cos
 /facos exch def

 %% amples possibles a DIN i en funció dels margeS triats
 [  %% només considerem l'ample perquè la componedora només compon 1 sola línia
  595 margeS 2 mul sub  %% 0 A4 vertical
  842 margeS 2 mul sub  %% 1 A4 horitzontal
  842 margeS 2 mul sub  %% 2 A3 vertical
  1191 margeS 2 mul sub %% 3 A3 horitzontal
  1191 margeS 2 mul sub %% 4 A2 vertical
  1684 margeS 2 mul sub %% 5 A2 horitzontal
  1684 margeS 2 mul sub %% 6 A1 vertical
  2384 margeS 2 mul sub %% 7 A1 horitzontal
  2384 margeS 2 mul sub %% 8 A0 vertical
  3370 margeS 2 mul sub %% 9 A0 horitzontal
 ] /Xpossible exch def

 %% https://www.cl.cam.ac.uk/~mgk25/iso-paper.html
 [  %% formats de pàgina
  [595 842]  %% 0 A4 vertical
  [842 595]  %% 1 A4 horitzontal
  [842 1191]  %% 2 A3 vertical
  [1191 842]  %% 3 A3 horitzontal
  [1191 1684]  %% 4 A2 vertical
  [1684 1191]  %% 5 A2 horitzontal
  [1684 2384]  %% 6 A1 vertical
  [2384 1684]  %% 7 A1 horitzontal
  [2384 3370]  %% 8 A0 vertical
  [3370 2384]  %% 9 A0 horitzontal
 ] /A4_A0 exch def

 [  %% formats de pàgina per escrit
  (A4 vertical)
  (A4 horitzontal)
  (A3 vertical)
  (A3 horitzontal)
  (A2 vertical)
  (A2 horitzontal)
  (A1 vertical)
  (A1 horitzontal)
  (A0 vertical)
  (A0 horitzontal)
 ] /litA4_A0 exch def

 /iFormat 0 def
 Xpossible
 {  %% forall per avaluar l'índex de quin format empremptem el resultat
  falinia ge
  {
   exit
  }if
  iFormat 1 add /iFormat exch def
 }forall

 <<
   /PageSize A4_A0 iFormat get
   %% per assegurar precisió i qualitat
   /HWResolution [4000 4000]
 >> setpagedevice

 (/usr/share/fonts/truetype/hack/Hack-Regular.ttf)
 findfont
 dup length dict begin
 {
  1 index /FID ne
  {def}{pop pop}ifelse
 }forall
 /Encoding systemdict /EncodingDirectory get /WinAnsiEncoding get def
 currentdict end
 /mono_WA exch definefont pop

 %% mesurem l'ample dels glifs a 1 punt de cos
 /mono_WA 1 selectfont
 0 0 moveto (i) stringwidth pop /ampleA1puntDcos exch def

 tOU
 (E L) search
 {  %% filtrem el missatge del prompt a la cua del buffer de 2048
  exch pop exch pop
 }
 {  %% si esgotessim el buffer ho detectariem per aquí
  TENIMunERRORamb_toU
 }ifelse

 %% lector/componedor dels caràcters que es codifiquen en simple, doble i triple octet i per destriar \n com a retorn de carro i \' com apòstrof
 (decodificaWinAnsiEncoding_a1i2octets.ps)
 (r) file cvx exec

 %% afegim la darrera cadena amb la URL executada dins l'array
 AliniesD1solOctet dup length dup /araVa exch def 1 add array dup 3 -1 roll 0 exch putinterval
 dup araVa laURL put /AliniesD1solOctet exch def

 /lamesllarga 0 def  %% detectem quina és la línia més llarga
 AliniesD1solOctet
 {  %% forall
  length dup lamesllarga gt
  {
   /lamesllarga exch def
  }
  {
   pop
  }ifelse
 }forall
 
 %% l'ample de pàgina imprimible dividit pel producte del nombre de glifs de la línia més llarga per l'ample d'1 glif a 1 punt
 %% és = al coS perquè la línia més llarga faci exactament l'ample imprimible de pàgina
 Xpossible iFormat get  %% l'ample imprimible de pàgina
 lamesllarga  %% nombre de glifs de la línia més llarga
 ampleA1puntDcos  %% l'ample d'1 glif a 1 punt
 mul div
 /coS exch def
 
 /iL coS 1.12 mul def
 /caP A4_A0 iFormat get 1 get margeS sub iL sub def

 %% logo UB
 gsave
 /DeviceRGB setcolorspace
 margeS A4_A0 iFormat get 1 get margeS 2.2 mul sub translate
 32 40.5 scale
 <<
   /ImageType 1
   /Width 64
   /Height 81
   /BitsPerComponent 8
   /Decode [0 1 0 1 0 1]
   /ImageMatrix [64 0 0 81 neg 0 81]
   /DataSource (nomesLogo2UB.jpg) (r) file <</ColorTransform 1>> /DCTDecode filter  %% treballant amb filtres no s'hi posen els {}
 >> image
 grestore

 %% fem que el cos fix del text quadri amb el logo UB
 %% capçalera amb el nom del projecte i logo a caixa esquerra
 /mono_WA findfont 9 scalefont setfont
 margeS 2.5 mul A4_A0 iFormat get 1 get margeS sub 8 sub dup /araIL exch def moveto
 (Taller Virtual de Tipografia en Plom) show
 margeS 2.5 mul araIL 10 1.12 mul sub moveto
 (Projecte RIMDA 2024DIG-UB/005) show
 margeS 2.5 mul araIL 10 1.12 2 mul mul sub moveto
 (Facultat de Belles Arts) show

 %% capçalera amb el nom de la componedora a caixa dreta, ídem cos del logo UB
 /mono_WA findfont 9 scalefont setfont
 gsave
 1 0 0 setrgbcolor
 0 0 moveto (componedoraRIMDA00) dup stringwidth pop
 Xpossible iFormat get  %% l'ample imprimible de pàgina
 exch sub margeS add araIL moveto show
 grestore

 <efb34a>  %% color or vell ídem html
 {
  255 div
 }forall
 setrgbcolor

 %% centrat a peu de pàgina
 /mono_WA findfont coS scalefont setfont
 %% componem la URL que fa tot l'ample de la pàgina ajustada als margeS
 AliniesD1solOctet dup 4 get margeS dup moveto show
 %% componem la desviació permesa
 0 get dup 0 0 moveto stringwidth pop 2 div
 Xpossible iFormat get 2 div exch sub  %% l'ample imprimible de pàgina
 margeS iL add moveto show

 %% componem el format de pàgina en literari
 litA4_A0 iFormat get dup 0 0 moveto stringwidth pop 2 div
 Xpossible iFormat get 2 div exch sub  %% l'ample imprimible de pàgina
 margeS iL 2 mul add moveto show

 %% la línia de composició centrada en horitzontal i vertical
 A4_A0 iFormat get cvx exec
 exch 2 div falinia 2 div sub dup /Xibalet exch def  %% la X per centrar horitzontalment la mesura
 exch 2 div facos 2 div sub dup /Yibalet exch def  %% la Y per centrar verticalment la mesura
 falinia facos rectfill


 %% les 2 regles graduades de dalt (cíceros/punts) i baix (cm/mm)
 gsave
 %% 1 punt Didot = 1.06554329 punts de Pica PS  %% aquest és el multiplicador mestre que haurem de fer servir pels algorismes del Taller de Tipografia de la FBBAAUB
 /pD {1.06554329 mul}bind def
 %% 1 mm = 2.83464575 punts de Pica PS=
 /mm {2.83464575 mul}bind def

%%+ tipus
 (/usr/share/fonts/truetype/ubuntu/Ubuntu-C.ttf)
 findfont
 %% codifiquem pels accents catalans i els possibles glifs alternatius
 dup length dict begin
 {
  1 index /FID ne
  {def}{pop pop}ifelse
 }forall
 %% atenció que aquesta crida només és vàlida a Ghostscript!
 /Encoding systemdict /EncodingDirectory get /WinAnsiEncoding get
 %dup length array copy dup 0
 %/Fhook put
 %/uni0191 put
 %/uni0492 put
 %/Ghestrokecyrillic put
 %/ghestrokecyrillic put
 %/uni024D put
 %/florin put
 %/f put
 %/uni0493 put
 %/f_f put
 def  %% xifrat WinAnsi
 currentdict end /dUbuntu_WAp exch definefont pop
 /dUbuntu_WAp findfont
 /dFont exch def

 %% marques de la regla mm/cm
 /Ymm 5 mm def
 /Ymig 7.5 mm def
 /Ycm 10 mm def

 %% marques de la regla punts/cíceros Didot
 /YpD 12 pD def
 /YmigpD 24 pD def
 /Yc 36 pD def

 true  %% quin mètode de comparació fem servir? (puntsPS vs mm)
 /mtdC exch def
%%+ llindar en punts de Pica PS per sobre del qual (en valor absolut) desestimarem la concordança d'unitats
 /llindarIDEM .13 def  %% segons l'Enric Tormo: 48 punts Didot = 18 mm = concordança mestre, només quadra quan posem un llindar a partir de 0.13

 %% marquem en vermell les coincidències més acostades entre punts vs mm i mm vs punts
 %% de manera que comprovant aquests valors veiem que en punts de Pica PS (la unitat nadiua del PDF) les coincidències són al primer decimal:
 %% 8 p vs 3 mm | 11 c amb 9 p vs 53 mm | 12 c amb 5 p vs 56 mm | 22 c amb 10 p vs 103 mm | 23 c amb 6 p vs 106 mm | 35 c amb 3 p vs 159 mm | 47 c amb 0 p vs 212 mm
 %% o al segon: 34 c amb 7 p vs 156 mm | 46 c amb 4 p vs 209 mm
 /aCoincidencies <<>> def  %% diccionari amb posicions en mm vs null que indicaran les coincidències amb punts Didot

%%+ regla horitzontal en punts/cíceros Didot
 gsave
 /cmlt 0 def  %% unitats acumulades en punts Didot
 /cmltMM 0 def  %% unitats acumulades en mm
 Xibalet Yibalet facos add translate
 0 setlinewidth
 /ic 0 def

 falinia 1.06554329 div 12 div ceiling cvi  %% nombre de cíceros a fer
 {
  0 1 11
  {
   dup /arac exch def
   pD dup

   mtdC  %% fem servir dos mètodes per detectar la coincidència d'unitats
   {  %% +precís: amb dos comptadors de salts d'unitat convertim els salts de punt Didot i els salts de mm a punt de Pica PS i els comparem en base al llindarIDEM
    cmlt 1.06554329 mul  %% de punt Didot a punt de Pica PS
    cmltMM 2.83464575 mul  %% de mm a punt de Pica PS
    2 copy sub abs llindarIDEM gt
    {  %% desestimem la coincidència d'unitats
     %% com fem córrer els comptadors d'unitats?
     gt  %% els punts Didot han superat els mm?
     {
      cmltMM 1 add /cmltMM exch def
     }if
     cmlt 1 add /cmlt exch def
     false
    }
    {  %% hi ha coincidència d'unitats!
%%EP! hem de desactivar els missatges del prompt perquè ens maten l'alert JS
     %% llistem: els 2 valors en punts de Pica PS
     %(\n\n >>> coindidència d'unitats: )print flush 32 string
     pop %cvs print flush
     %( (pDidot) vs ) print flush
     pop %32 string cvs print flush ( (mm)\n)print flush
     %% llistem els punts Didot que coincideixen amb els mm
     %cmlt 6 string cvs print flush ( punts Didot ...ídem a... )print flush
     %% llistem els mm que coincideixem amb els punts Didot
     cmltMM 6 string cvs %dup print flush ( mm)print flush
     aCoincidencies exch null put  %% desem per quan fem els mm
     %% fem córrer els comptadors d'unitats
     cmltMM 1 add /cmltMM exch def
     cmlt 1 add /cmlt exch def
     true
    }ifelse
   }
   {  %% -precís: convertim els punts Didot a mm i desem només els que a la part decimal comencen amb 2 zeros
    cmlt
    .3759 mul  %% quin valor a mm dóna 2 zeros decimals?
    100 mul cvi 32 string cvs dup length dup 1 eq
    {
     1 sub 1 getinterval cvx exec 0 eq
    }
    {
     2 sub 2 getinterval cvx exec 0 eq
    }ifelse
    cmlt 1 add /cmlt exch def
   }ifelse
   /aVermell exch def  %% marcarem en vermell les coinncidències punts vs mm

   0 pD moveto
   arac 6 eq
   {
    YmigpD
   }
   {
    arac 0 eq
    {
     Yc
     gsave
     0 0 0 setrgbcolor
     2 copy moveto dFont 10 scalefont setfont ic 3 string cvs show
     ic 1 add /ic exch def
     grestore
    }
    {
     YpD
    }ifelse
   }ifelse
   aVermell
   {
    1 0 0 setrgbcolor
   }
   {
    0 0 0 setrgbcolor
   }ifelse
   lineto stroke
   0 0 0 setrgbcolor
  }for
  12 pD 0 translate
 }repeat
 %% la darrera marca en cíceros
 0 0 moveto 0 Yc
 gsave
 0 0 0 setrgbcolor
 2 copy moveto dFont 10 scalefont setfont ic 3 string cvs show ( c\355ceros) show
 grestore
 lineto stroke
 grestore


%%+ regla horitzontal en mm/cm
 gsave
 /cmlt 0 def  %% unitats acumulades en mm
 /cmltPD 0 def  %% unitats acumulades en punts Didot
 Xibalet Yibalet translate
 0 setlinewidth
 /icm 0 def
 falinia 2.83464575 div 10 div ceiling cvi  %% nombre de centímetres a fer
 {
  0 1 9
  {
   dup /aramm exch def
   mm dup

   mtdC  %% fem servir dos mètodes de comparació
   {  %% +precís: amb dos comptadors de salts d'unitat convertim els salts en mm i els salts en punts Didot a punt de Pica PS i els comparem en base al llindarIDEM

    aCoincidencies cmlt 6 string cvs known
    {
     true
    }
    {
     false
    }ifelse

    cmlt 1 add /cmlt exch def
   }
   {  %% -precís: convertim els mm a punts Didot i desem només els que a la part decimal comencen amb 2 zeros
    cmlt 1 .3759 div mul %% quin valor a punts dóna 2 zeros decimals?
    100 mul cvi 32 string cvs dup length dup 1 eq
    {
     1 sub 1 getinterval cvx exec 0 eq
    }
    {
     2 sub 2 getinterval cvx exec 0 eq
    }ifelse
    cmlt 1 add /cmlt exch def
   }ifelse
   /aVermell exch def  %% marcarem en vermell les coinncidències punts vs mm

   0 mm moveto
   aramm 5 eq
   {
    Ymig neg
   }
   {
    aramm 0 eq
    {
     Ycm neg
     gsave
     0 0 0 setrgbcolor
     2 copy 10 neg add moveto dFont 10 scalefont setfont icm 3 string cvs show
     icm 1 add /icm exch def
     grestore
    }
    {
     Ymm neg
    }ifelse
   }ifelse
   aVermell
   {
    1 0 0 setrgbcolor
   }
   {
    0 0 0 setrgbcolor
   }ifelse
   lineto stroke
  }for
  10 mm 0 translate
 }repeat
 %% la darrera marca en cm
 0 0 moveto 0 Ycm neg
 gsave
 0 0 0 setrgbcolor
 2 copy 10 neg add moveto dFont 10 scalefont setfont icm 3 string cvs show ( cm) show
 grestore
 lineto stroke
 grestore


 %% cal poder perfilar només en blanc les peces del &reng= a compondre vs omplir-les (primer de color i després amb la seva digitalització)
 gsave
 /araX 0 def
 0 setlinewidth
 Xibalet Yibalet translate
 LINPSnorm 2 get  %% mesura de línia
 /ipesa 0 def  %% aquest índex ara serveix per a extraure les dades de cada peça del &reng= i enumerar-les a /T
 /araXanot 0 def  %% suma progressiva de les X per situar el Widget
 {  %% forall per totes les peces del &reng=
%%EPS ja hem inclòs aquest paràmetre dins una variable URL
  nua  %% ve, si existeix, de la variable &nua= i si val true només perfilem
  {
   gsave
   1 1 1 setrgbcolor
   1 get dup length
   2 eq
   {  %% duu cos i ample
    0 exch 0 exch
    araX
    dup /araXanot exch def
    0 translate
    cvx exec dup araX add
    /araX exch def
    exch 4 copy 4 array astore /araRect exch def  %% capturem el Rect
    rectstroke
   }
   {  %% bomés duu ample
    0 exch 0 exch
    araX
    dup /araXanot exch def
    0 translate
    cvx exec dup araX add
    /araX exch def
    facos 4 copy 4 array astore /araRect exch def  %% capturem el Rect
    rectstroke
   }ifelse
   grestore
  }
  {  %% perfilem i omplim!
   gsave
   dup 0 get /araColorMB exch def  %% ara és un color però podria ser la imatge de la peça
   1 get dup length
   2 eq
   {  %% duu cos i ample
    0 exch 0 exch
    araX
    dup /araXanot exch def
    0 translate
    cvx exec dup araX add
    /araX exch def
    exch 4 copy 
    araColorMB cvx exec rectfill
    4 copy 4 array astore /araRect exch def  %% capturem el Rect
    1 1 1 setrgbcolor rectstroke
   }
   {  %% bomés duu ample
    0 exch 0 exch
    araX
    dup /araXanot exch def
    0 translate
    cvx exec dup araX add
    /araX exch def
    facos 4 copy 
    araColorMB cvx exec rectfill
    4 copy 4 array astore /araRect exch def  %% capturem el Rect
    1 1 1 setrgbcolor rectstroke
   }ifelse
   grestore
  }ifelse

%%EPS aquí va l'anotació pel tooltip que identificarà per pantalla cada peça del &reng=
  mark
  /Rect araRect dup 0 araXanot put dup dup 2 get araXanot add 2 exch put
  %ipesa 2 eq {pstack AAVEEUUREE}if  %% per si ho volem aturar en una determinada peça
  /Subtype /Widget
  /Ff 65536
  %% generem un nom únic lligant l'índex de la peça i la posicio Y
  /T
  Yibalet 64 string cvs dup length
  ipesa 64 string cvs
  dup length 3 -1 roll add 1 add string dup /araT exch def
  /NullEncode filter /fT exch def
  fT exch writestring fT (_) writestring fT exch writestring
  fT dup flushfile closefile araT
  %% l'etiqueta la forma el nom i valors de la peça (aplicant-hi el gir si en té)
  /TU
  URLnorm 2 get ipesa get mark exch  %% així sabrem quantes cadenes que descriuen la peça hem d'enganxar
  {
   dup type /nametype eq
   {
    128 string cvs
   }
   {
    {
     128 string cvs
    }forall
   }ifelse
  }forall
  counttomark dup /faTU exch def
  array astore dup
  {  %% comptem quan ha de fer la cadena que ho enganxi tot
   length faTU add /faTU exch def
  }forall
  faTU string dup /araTU exch def /NullEncode filter /fTU exch def
  {
   fTU exch writestring
   fTU ( ) writestring
  }forall
  fTU dup flushfile closefile
  araTU exch pop
  /FT /Btn
  /H /N  %% cal veure quina visualització ens convé més
  %% en cas que féssim vincles ...
  %% /AA <</D << /S /Launch /F << /Type /Filespec /F pdfNEXT >> >> >>
  /ANN
  pdfmark
  ipesa 1 add /ipesa exch def
 }forall  %% per totes les peces del &reng=
 grestore
 grestore
 showpage

%%EPS que més hi mancaria al PDF de la composició del &rebg= ?
 %% triar quins elements és interessant posar en capes
 %% triar la lògica d'amidaments per pantalla
 %% triar com indiquem al PDF el tipus, cos i ample de cadascuna de la peces del &reng=
}ifelse


false{

{  %% stopped

%%PODEM llistar una string via funcions JS alert() o window.confirm() o window.prompt()
%% amb = que ignora els () i amb == que es veuen

%% tou de text admès:
%% fins a 1000 caràcters, prou bé
%% \\r \\n \\t  tot són retorns de carro equivalents!
%% caràcters reservats que hem detectat que necessiten scape doncs sinó el JS es queda en blanc i no interpreta res:
%% parèntesi: \( \)
%% apòstrof: \\'
%% JS no interpreta ni CSS ni HTML
%% ens cal formatar un text molt bàsic per informar dels errors comesos

%(0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::100::\\n0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::200::\\n\\n0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::300::\\r0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::400::\\r\\r0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::500\\n\\t0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::600\\n\\n\\t\\t0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::7000123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::800::0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::900::0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789::1000\000\000)

%(\\000\\000\000\000\000\000\000\000\\n\000\000\000\000\000\000\000\000\\n\000\000\000\000\000\000\000\000\\n\000\000\000\000\000\000\000\000\\n\000\000\000\000\000\000\000\000\\n\000\000\000\000\000\000\000\000\\n)

%% fem que surti l'error al prompt de la web?
fotli dup flushfile closefile
tOU

%% just el que necessita el JS per fer el prompt
=  %% treu tot el contingut de la cadena interpretant els retorns de carro correctament
%% == %% treu la cadena amb el () sense interpretar el seu interior 

%%Operadors a qui no agrada a les funcions JS alert() o window.confirm()
%% pstack / stack
%%EN CANVI:
%% = i ==
%% deixa que les funcions de JS ens anotin tot el valor de l'stack via la variable $prompt de componedoraRIMDA00.php


%%ERRORS A GESTIONAR per ordre de prioritat
%% DE SINTAXI DINS LA URL
    %% com es produeix
    %% qui ho detecta?
    %% com ho informem?
    %% cap a on deriva?
  %% a la manca de variables | al nom de les variables | a la sintaxi amb = &
  %% a la sintaxi del nom de les Mesures de Blancs
  %% a la sintaxi dels valors de les Mesures de Blancs
%% DE MESURES
  %% la peça de Mesura de Blancs no es troba dins de la taula
  %% la suma de Mesures de Blanc supera o no arriba al valor exacte (llindar d'1 punt?) de la variable mesura

%%+ un error de sintaxi és el millor mètode per provocar que tota l'stack quedi plasmada al prompt html que canalitzem via php
% aixoESunERRORdeSINTAXI

}stopped
{
 (EMveus?) pstack
}if

}if
